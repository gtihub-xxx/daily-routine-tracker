<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルーティン記録アプリ v2.8.0</title>
    <style>
        /* ========================================
           CSS Variables & Reset
        ======================================== */
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff6b6b;
            --text-primary: #333;
            --text-secondary: #666;
            --border-light: #ddd;
            --background-light: #f8f9fa;
            --background-white: #ffffff;
            --border-radius: 8px;
            --border-radius-large: 15px;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ========================================
           Base Styles
        ======================================== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            padding: 10px;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent; /* スマホ用タップハイライト削除 */
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--background-white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* ========================================
           Header Styles
        ======================================== */
        .header {
            background: var(--primary-gradient);
            color: var(--background-white);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .date {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ========================================
           Navigation Styles
        ======================================== */
        .nav-tabs {
            display: flex;
            background: var(--background-light);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            color: var(--text-secondary);
            -webkit-user-select: none;
            user-select: none;
        }

        .nav-tab.active {
            background: var(--background-white);
            color: #4facfe;
            font-weight: bold;
        }

        /* ========================================
           Content & Section Styles
        ======================================== */
        .content {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .routine-section {
            margin-bottom: 25px;
            background: var(--background-light);
            border-radius: var(--border-radius-large);
            padding: 20px;
            position: relative;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .section-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .streak-badge {
            background: linear-gradient(135deg, var(--warning-color), #feca57);
            color: var(--background-white);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ========================================
           Form Elements
        ======================================== */
        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none; /* iOS用デフォルトスタイル削除 */
        }

        .input-field:focus {
            outline: none;
            border-color: #4facfe;
        }

        .textarea-field {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 12px;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
            margin-top: 8px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        .textarea-field:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* ========================================
           Button Styles
        ======================================== */
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            color: var(--background-white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #6c757d;
            color: var(--background-white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Button Color Variants */
        .btn-exercise { background: #ff6b6b; }
        .btn-massage { background: #4ecdc4; }
        .btn-study { background: #45b7d1; }
        .btn-reading { background: #96ceb4; }
        .btn-spending { background: #f39c12; }
        .btn-export { background: #28a745; }
        .btn-import { background: #007bff; }
        .btn-clear { background: var(--error-color); }

        /* ========================================
           Checkbox & Interactive Elements
        ======================================== */
        .checkbox-item {
            display: flex;
            align-items: center;
            background: var(--background-white);
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
            -webkit-user-select: none;
            user-select: none;
        }

        .checkbox-item.checked {
            background: #e8f5e8;
            border-color: var(--success-color);
        }

        .checkbox-item input {
            margin-right: 8px;
        }

        .study-item {
            margin-bottom: 20px;
            background: var(--background-white);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .study-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }

        .study-checkbox input {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .study-checkbox.checked {
            color: var(--success-color);
        }

        /* ========================================
           Spending Styles
        ======================================== */
        .spending-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .spending-item {
            background: var(--background-white);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .spending-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }

        .spending-checkbox input {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .spending-checkbox.checked {
            color: #f39c12;
        }

        .spending-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .spending-amount {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
        }

        .currency {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: bold;
            min-width: 20px;
        }

        .spending-total {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .spending-total-label {
            font-size: 14px;
            color: #856404;
            margin-bottom: 5px;
        }

        .spending-total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #f39c12;
        }

        /* ========================================
           Statistics & Totals
        ======================================== */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--background-light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .exercise-totals,
        .other-totals,
        .study-totals,
        .spending-totals {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .exercise-total-item,
        .other-total-item,
        .study-total-item,
        .spending-total-item {
            display: flex;
            align-items: center;
            background: var(--background-white);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            transition: var(--transition);
        }

        .exercise-total-item:hover,
        .other-total-item:hover,
        .study-total-item:hover,
        .spending-total-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-icon,
        .other-icon,
        .study-icon,
        .spending-icon {
            font-size: 20px;
            margin-right: 15px;
            min-width: 25px;
            text-align: center;
        }

        .exercise-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .exercise-info,
        .other-info,
        .study-info,
        .spending-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-name,
        .other-name,
        .study-name,
        .spending-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .exercise-name {
            font-size: 16px;
        }

        .exercise-count,
        .other-count,
        .study-count,
        .spending-count {
            font-size: 16px;
            font-weight: bold;
            color: #4facfe;
        }

        .exercise-count {
            font-size: 18px;
        }

        .study-count {
            color: #45b7d1;
        }

        .spending-count {
            color: #f39c12;
        }

        /* Sum Variants */
        .exercise-total-sum,
        .study-total-sum,
        .spending-total-sum {
            font-weight: bold;
            color: var(--background-white);
            border: none;
        }

        .exercise-total-sum {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
        }

        .study-total-sum {
            background: linear-gradient(135deg, #45b7d1, #96ceb4);
        }

        .spending-total-sum {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .exercise-total-sum .exercise-name,
        .exercise-total-sum .exercise-count,
        .study-total-sum .study-name,
        .study-total-sum .study-count,
        .spending-total-sum .spending-name,
        .spending-total-sum .spending-count {
            color: var(--background-white);
        }

        .exercise-total-sum .exercise-count {
            font-size: 20px;
        }

        .study-total-sum .study-count {
            font-size: 18px;
        }

        .spending-total-sum .spending-count {
            font-size: 18px;
        }

        /* ========================================
           Period Tabs
        ======================================== */
        .period-tabs {
            display: flex;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 15px;
            gap: 2px;
        }

        .period-tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            -webkit-user-select: none;
            user-select: none;
        }

        .period-tab.active {
            background: var(--background-white);
            color: #4facfe;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .period-tab:hover:not(.active) {
            background: rgba(255,255,255,0.5);
        }

        .period-info {
            background: #e8f4fd;
            color: #2c5aa0;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* ========================================
           Calendar
        ======================================== */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: bold;
        }

        .calendar-header {
            background: #667eea;
            color: var(--background-white);
        }

        .calendar-date {
            background: #f0f0f0;
            color: #999;
        }

        .calendar-date.completed {
            background: var(--success-color);
            color: var(--background-white);
        }

        .calendar-date.today {
            background: #2196f3;
            color: var(--background-white);
        }

        /* ========================================
           Settings
        ======================================== */
        .settings-section {
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .time-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .notification-times {
            padding: 10px;
            background: var(--background-light);
            border-radius: 10px;
            margin-top: 10px;
        }

        .notification-times .input-group {
            margin-bottom: 15px;
        }

        .notification-times .input-group:last-child {
            margin-bottom: 0;
        }

        .file-input {
            display: none;
        }

        .app-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 20px;
            padding: 15px;
            background: var(--background-light);
            border-radius: 10px;
        }

        .storage-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-indicator.error {
            background: var(--error-color);
        }

        .memo-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .spending-summary {
            display: flex;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .spending-summary-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .summary-value {
            font-size: 14px;
            font-weight: bold;
            color: #f39c12;
        }

        /* ========================================
           Toast & Loading States
        ======================================== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: var(--background-white);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
            transition: var(--transition);
        }

        .toast.error {
            background: var(--error-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* ========================================
           Responsive Design
        ======================================== */
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .routine-section {
                padding: 15px;
            }
        }

        @media (max-width: 350px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <div class="header">
            <div class="version-badge">v2.8.0</div>
            <div class="date" id="current-date"></div>
            <div class="subtitle">今日のルーティンを記録しましょう</div>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="record">記録</button>
            <button class="nav-tab" data-tab="history">履歴</button>
            <button class="nav-tab" data-tab="settings">設定</button>
        </nav>

        <div class="content">
            <!-- 記録タブ -->
            <section class="section active" id="record">
                <!-- 運動セクション -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">💪 運動</span>
                        <span class="streak-badge" id="exercise-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="pushups">腕立て伏せ（回）</label>
                        <input type="number" class="input-field" id="pushups" placeholder="回数を入力" min="0" max="9999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="situps">腹筋（回）</label>
                        <input type="number" class="input-field" id="situps" placeholder="回数を入力" min="0" max="9999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="squats">スクワット（回）</label>
                        <input type="number" class="input-field" id="squats" placeholder="回数を入力" min="0" max="9999">
                    </div>
                    <button class="btn-secondary btn-exercise" id="save-exercise-btn">💪 運動を記録</button>
                </div>

                <!-- マッサージセクション -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">🫧 マッサージ</span>
                        <span class="streak-badge" id="massage-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="massage-time">マッサージ時間（分）</label>
                        <input type="number" class="input-field" id="massage-time" placeholder="時間を入力" min="0" max="999">
                    </div>
                    <button class="btn-secondary btn-massage" id="save-massage-btn">🫧 マッサージを記録</button>
                </div>

                <!-- 勉強セクション -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📚 勉強</span>
                        <span class="streak-badge" id="study-streak">0日継続</span>
                    </div>
                    
                    <div class="study-item">
                        <div class="study-item-header" data-subject="english">
                            <label class="study-checkbox">
                                <input type="checkbox" id="english">
                                <span>🇺🇸 英語</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="english-memo" placeholder="英語の学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="bookkeeping">
                            <label class="study-checkbox">
                                <input type="checkbox" id="bookkeeping">
                                <span>📊 簿記</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="bookkeeping-memo" placeholder="簿記の学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="fp">
                            <label class="study-checkbox">
                                <input type="checkbox" id="fp">
                                <span>💰 ファイナンシャルプランナー</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="fp-memo" placeholder="FPの学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="ai">
                            <label class="study-checkbox">
                                <input type="checkbox" id="ai">
                                <span>🤖 AI</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="ai-memo" placeholder="AIの学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>
                    
                    <button class="btn-secondary btn-study" id="save-study-btn">📚 勉強を記録</button>
                </div>

                <!-- 読書セクション -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📖 読書</span>
                        <span class="streak-badge" id="reading-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="reading-time">読書時間（分）</label>
                        <input type="number" class="input-field" id="reading-time" placeholder="時間を入力" min="0" max="999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="book-title">本のタイトル</label>
                        <input type="text" class="input-field" id="book-title" placeholder="本のタイトル" maxlength="100">
                    </div>
                    <button class="btn-secondary btn-reading" id="save-reading-btn">📖 読書を記録</button>
                </div>

                <!-- 嗜好品セクション -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">☕ 嗜好品への出費</span>
                        <span class="streak-badge" id="spending-streak">0日継続</span>
                    </div>
                    
                    <div class="spending-items">
                        <div class="spending-item">
                            <div class="spending-header" data-item="coffee">
                                <label class="spending-checkbox">
                                    <input type="checkbox" id="coffee">
                                    <span>☕ コーヒー</span>
                                </label>
                            </div>
                            <div class="spending-input">
                                <input type="number" class="input-field spending-amount" id="coffee-amount" placeholder="金額" min="0" max="99999">
                                <span class="currency">円</span>
                            </div>
                        </div>

                        <div class="spending-item">
                            <div class="spending-header" data-item="snacks">
                                <label class="spending-checkbox">
                                    <input type="checkbox" id="snacks">
                                    <span>🍫 お菓子</span>
                                </label>
                            </div>
                            <div class="spending-input">
                                <input type="number" class="input-field spending-amount" id="snacks-amount" placeholder="金額" min="0" max="99999">
                                <span class="currency">円</span>
                            </div>
                        </div>

                        <div class="spending-item">
                            <div class="spending-header" data-item="alcohol">
                                <label class="spending-checkbox">
                                    <input type="checkbox" id="alcohol">
                                    <span>🍺 アルコール</span>
                                </label>
                            </div>
                            <div class="spending-input">
                                <input type="number" class="input-field spending-amount" id="alcohol-amount" placeholder="金額" min="0" max="99999">
                                <span class="currency">円</span>
                            </div>
                        </div>

                        <div class="spending-item">
                            <div class="spending-header" data-item="cigarettes">
                                <label class="spending-checkbox">
                                    <input type="checkbox" id="cigarettes">
                                    <span>🚬 タバコ</span>
                                </label>
                            </div>
                            <div class="spending-input">
                                <input type="number" class="input-field spending-amount" id="cigarettes-amount" placeholder="金額" min="0" max="99999">
                                <span class="currency">円</span>
                            </div>
                        </div>

                        <div class="spending-item">
                            <div class="spending-header" data-item="others">
                                <label class="spending-checkbox">
                                    <input type="checkbox" id="others">
                                    <span>🛒 その他</span>
                                </label>
                            </div>
                            <div class="spending-input">
                                <input type="number" class="input-field spending-amount" id="others-amount" placeholder="金額" min="0" max="99999">
                                <span class="currency">円</span>
                            </div>
                            <input type="text" class="input-field spending-memo" id="others-memo" placeholder="内容を記録" maxlength="50">
                        </div>
                    </div>
                    
                    <div class="spending-total">
                        <div class="spending-total-label">今日の合計</div>
                        <div class="spending-total-amount" id="daily-spending-total">0円</div>
                    </div>
                    
                    <button class="btn-secondary btn-spending" id="save-spending-btn">💰 嗜好品出費を記録</button>
                </div>

                <button class="btn-primary" id="save-record-btn">💾 全ての記録を保存</button>
            </section>

            <!-- 履歴タブ -->
            <section class="section" id="history">
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-exercise-days">0</div>
                        <div class="stat-label">運動日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-massage-days">0</div>
                        <div class="stat-label">マッサージ日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-study-days">0</div>
                        <div class="stat-label">勉強日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-reading-days">0</div>
                        <div class="stat-label">読書日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-spending-days">0</div>
                        <div class="stat-label">出費日数</div>
                    </div>
                </div>

                <!-- 運動の履歴 -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">💪 運動の累計回数</span>
                    </div>
                    
                    <div class="period-tabs">
                        <button class="period-tab active" data-period="week">今週</button>
                        <button class="period-tab" data-period="month">今月</button>
                        <button class="period-tab" data-period="year">今年</button>
                        <button class="period-tab" data-period="all">全期間</button>
                    </div>
                    
                    <div class="period-info" id="period-info">
                        今週 (月曜日〜日曜日)
                    </div>
                    
                    <div class="exercise-totals">
                        <div class="exercise-total-item">
                            <div class="exercise-icon">💪</div>
                            <div class="exercise-info">
                                <div class="exercise-name">腕立て伏せ</div>
                                <div class="exercise-count" id="total-pushups">0回</div>
                            </div>
                        </div>
                        <div class="exercise-total-item">
                            <div class="exercise-icon">🔥</div>
                            <div class="exercise-info">
                                <div class="exercise-name">腹筋</div>
                                <div class="exercise-count" id="total-situps">0回</div>
                            </div>
                        </div>
                        <div class="exercise-total-item">
                            <div class="exercise-icon">🦵</div>
                            <div class="exercise-info">
                                <div class="exercise-name">スクワット</div>
                                <div class="exercise-count" id="total-squats">0回</div>
                            </div>
                        </div>
                        <div class="exercise-total-item exercise-total-sum">
                            <div class="exercise-icon">🏆</div>
                            <div class="exercise-info">
                                <div class="exercise-name">総合計</div>
                                <div class="exercise-count" id="total-all-exercises">0回</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- マッサージの履歴 -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">🫧 マッサージの累計時間</span>
                    </div>
                    
                    <div class="other-totals">
                        <div class="other-total-item">
                            <div class="other-icon">🫧</div>
                            <div class="other-info">
                                <div class="other-name">マッサージ時間</div>
                                <div class="other-count" id="total-massage-time">0分</div>
                            </div>
                        </div>
                        <div class="other-total-item">
                            <div class="other-icon">📅</div>
                            <div class="other-info">
                                <div class="other-name">実施日数</div>
                                <div class="other-count" id="total-massage-days-period">0日</div>
                            </div>
                        </div>
                        <div class="other-total-item">
                            <div class="other-icon">⏱️</div>
                            <div class="other-info">
                                <div class="other-name">平均時間/日</div>
                                <div class="other-count" id="average-massage-time">0分</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 勉強の履歴 -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📚 勉強の累計日数</span>
                    </div>
                    
                    <div class="study-totals">
                        <div class="study-total-item">
                            <div class="study-icon">🇺🇸</div>
                            <div class="study-info">
                                <div class="study-name">英語</div>
                                <div class="study-count" id="total-english-days">0日</div>
                            </div>
                        </div>
                        <div class="study-total-item">
                            <div class="study-icon">📊</div>
                            <div class="study-info">
                                <div class="study-name">簿記</div>
                                <div class="study-count" id="total-bookkeeping-days">0日</div>
                            </div>
                        </div>
                        <div class="study-total-item">
                            <div class="study-icon">💰</div>
                            <div class="study-info">
                                <div class="study-name">FP</div>
                                <div class="study-count" id="total-fp-days">0日</div>
                            </div>
                        </div>
                        <div class="study-total-item">
                            <div class="study-icon">🤖</div>
                            <div class="study-info">
                                <div class="study-name">AI</div>
                                <div class="study-count" id="total-ai-days">0日</div>
                            </div>
                        </div>
                        <div class="study-total-item study-total-sum">
                            <div class="study-icon">📚</div>
                            <div class="study-info">
                                <div class="study-name">総学習日数</div>
                                <div class="study-count" id="total-study-days-period">0日</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 読書の履歴 -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📖 読書の累計時間</span>
                    </div>
                    
                    <div class="other-totals">
                        <div class="other-total-item">
                            <div class="other-icon">📖</div>
                            <div class="other-info">
                                <div class="other-name">読書時間</div>
                                <div class="other-count" id="total-reading-time">0分</div>
                            </div>
                        </div>
                        <div class="other-total-item">
                            <div class="other-icon">📚</div>
                            <div class="other-info">
                                <div class="other-name">読書日数</div>
                                <div class="other-count" id="total-reading-days-period">0日</div>
                            </div>
                        </div>
                        <div class="other-total-item">
                            <div class="other-icon">⏱️</div>
                            <div class="other-info">
                                <div class="other-name">平均時間/日</div>
                                <div class="other-count" id="average-reading-time">0分</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 嗜好品出費の履歴 -->
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">💰 嗜好品への出費</span>
                    </div>
                    
                    <div class="spending-totals">
                        <div class="spending-total-item">
                            <div class="spending-icon">☕</div>
                            <div class="spending-info">
                                <div class="spending-name">コーヒー</div>
                                <div class="spending-count" id="total-coffee-amount">0円</div>
                            </div>
                        </div>
                        <div class="spending-total-item">
                            <div class="spending-icon">🍫</div>
                            <div class="spending-info">
                                <div class="spending-name">お菓子</div>
                                <div class="spending-count" id="total-snacks-amount">0円</div>
                            </div>
                        </div>
                        <div class="spending-total-item">
                            <div class="spending-icon">🍺</div>
                            <div class="spending-info">
                                <div class="spending-name">アルコール</div>
                                <div class="spending-count" id="total-alcohol-amount">0円</div>
                            </div>
                        </div>
                        <div class="spending-total-item">
                            <div class="spending-icon">🚬</div>
                            <div class="spending-info">
                                <div class="spending-name">タバコ</div>
                                <div class="spending-count" id="total-cigarettes-amount">0円</div>
                            </div>
                        </div>
                        <div class="spending-total-item">
                            <div class="spending-icon">🛒</div>
                            <div class="spending-info">
                                <div class="spending-name">その他</div>
                                <div class="spending-count" id="total-others-amount">0円</div>
                            </div>
                        </div>
                        <div class="spending-total-item spending-total-sum">
                            <div class="spending-icon">💰</div>
                            <div class="spending-info">
                                <div class="spending-name">総支出</div>
                                <div class="spending-count" id="total-all-spending">0円</div>
                            </div>
                        </div>
                        <div class="spending-summary">
                            <div class="spending-summary-item">
                                <span class="summary-label">出費日数:</span>
                                <span class="summary-value" id="total-spending-days">0日</span>
                            </div>
                            <div class="spending-summary-item">
                                <span class="summary-label">平均/日:</span>
                                <span class="summary-value" id="average-daily-spending">0円</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- カレンダー -->
                <div class="routine-section">
                    <div class="section-name">📅 過去7日間の記録</div>
                    <div class="calendar-grid" id="weekly-calendar"></div>
                </div>
            </section>

            <!-- 設定タブ -->
            <section class="section" id="settings">
                <div class="settings-section">
                    <div class="settings-title">🔔 リマインド設定</div>
                    <label class="checkbox-item" data-toggle="notification">
                        <input type="checkbox" id="notification-enabled">
                        <span>通知を有効にする</span>
                    </label>
                    
                    <div class="notification-times">
                        <div class="input-group" style="margin-top: 15px;">
                            <label class="input-label" for="notification-time-1">🌅 リマインド時間 1（朝・昼）</label>
                            <div class="time-input">
                                <input type="time" class="input-field" id="notification-time-1" value="12:00">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label" for="notification-time-2">🌙 リマインド時間 2（夜）</label>
                            <div class="time-input">
                                <input type="time" class="input-field" id="notification-time-2" value="20:00">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">💾 データ管理</div>
                    <div class="data-controls">
                        <button class="btn-secondary btn-export" id="export-btn">データをエクスポート</button>
                        <button class="btn-secondary btn-import" id="import-btn">データをインポート</button>
                        <input type="file" class="file-input" id="import-file" accept=".json">
                        <button class="btn-secondary btn-clear" id="clear-btn">全データを削除</button>
                    </div>
                </div>

                <button class="btn-primary" id="save-settings-btn">設定を保存</button>

                <div class="app-info">
                    <div class="storage-status">
                        <div class="status-indicator" id="storage-indicator"></div>
                        <span id="storage-status">データ保存: 確認中...</span>
                    </div>
                    <div>ルーティン記録アプリ v2.8.0</div>
                    <div>新機能: 嗜好品への出費記録・管理</div>
                    <div>最終更新: 2025年6月16日</div>
                </div>
            </section>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        'use strict';

        // ===============================
        // アプリケーション設定
        // ===============================
        const CONFIG = {
            VERSION: '2.8.0',
            STORAGE_KEY: 'routineAppData_v2',
            SETTINGS_KEY: 'routineAppSettings_v2',
            
            // アプリケーションで使用する定数
            SUBJECTS: ['english', 'bookkeeping', 'fp', 'ai'],
            CATEGORIES: ['exercise', 'massage', 'study', 'reading', 'spending'],
            SPENDING_ITEMS: ['coffee', 'snacks', 'alcohol', 'cigarettes', 'others'],
            
            // 入力値の制限
            LIMITS: {
                EXERCISE_MAX: 9999,
                TIME_MAX: 999,
                TEXT_MAX: 100,
                MEMO_MAX: 1000,
                SPENDING_MAX: 99999
            },
            
            // デフォルト値
            DEFAULTS: {
                NOTIFICATION_TIME_1: '12:00',
                NOTIFICATION_TIME_2: '20:00',
                NOTIFICATION_ENABLED: false
            }
        };

        // DOM要素のセレクター
        const SELECTORS = {
            CONTAINER: '#app-container',
            CURRENT_DATE: '#current-date',
            SAVE_RECORD: '#save-record-btn',
            SAVE_EXERCISE: '#save-exercise-btn',
            SAVE_MASSAGE: '#save-massage-btn',
            SAVE_STUDY: '#save-study-btn',
            SAVE_READING: '#save-reading-btn',
            SAVE_SPENDING: '#save-spending-btn',
            SAVE_SETTINGS: '#save-settings-btn',
            EXPORT: '#export-btn',
            IMPORT: '#import-btn',
            CLEAR: '#clear-btn',
            IMPORT_FILE: '#import-file',
            TOAST: '#toast',
            STORAGE_INDICATOR: '#storage-indicator',
            STORAGE_STATUS: '#storage-status'
        };

        // ===============================
        // ユーティリティ関数
        // ===============================
        const Utils = {
            /**
             * 日付をYYYY-MM-DD形式でフォーマット
             */
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },

            /**
             * 今日の日付を取得
             */
            getToday() {
                return this.formatDate(new Date());
            },

            /**
             * 日付を日本語形式で表示
             */
            getDateString(date) {
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                return `${date.getMonth() + 1}月${date.getDate()}日（${days[date.getDay()]}）`;
            },

            /**
             * 数値の検証と正規化
             */
            validateNumber(value, min = 0, max = Infinity) {
                const num = parseInt(value) || 0;
                return Math.max(min, Math.min(max, num));
            },

            /**
             * テキストの検証と正規化
             */
            validateText(value, maxLength = Infinity) {
                return String(value || '').trim().substring(0, maxLength);
            },

            /**
             * ファイルダウンロード
             */
            downloadFile(data, filename, type = 'application/json') {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },

            /**
             * デバウンス処理
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ===============================
        // ローカルストレージ管理
        // ===============================
        const Storage = {
            /**
             * ローカルストレージサポート確認
             */
            isSupported() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch {
                    return false;
                }
            },

            /**
             * データ保存
             */
            save(key, data) {
                if (!this.isSupported()) return false;
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch {
                    return false;
                }
            },

            /**
             * データ読み込み
             */
            load(key) {
                if (!this.isSupported()) return null;
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch {
                    return null;
                }
            },

            /**
             * データ削除
             */
            remove(key) {
                if (!this.isSupported()) return false;
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        // ===============================
        // データ管理クラス
        // ===============================
        class DataManager {
            constructor() {
                this.reset();
            }

            /**
             * データの初期化
             */
            reset() {
                this.data = {
                    records: {},
                    version: CONFIG.VERSION,
                    lastUpdated: new Date().toISOString()
                };

                this.settings = {
                    notificationEnabled: CONFIG.DEFAULTS.NOTIFICATION_ENABLED,
                    notificationTime1: CONFIG.DEFAULTS.NOTIFICATION_TIME_1,
                    notificationTime2: CONFIG.DEFAULTS.NOTIFICATION_TIME_2,
                    version: CONFIG.VERSION
                };
            }

            /**
             * データの読み込み
             */
            load() {
                const savedData = Storage.load(CONFIG.STORAGE_KEY);
                const savedSettings = Storage.load(CONFIG.SETTINGS_KEY);

                if (savedData) {
                    this.data = this.migrateData(savedData);
                }

                if (savedSettings) {
                    this.settings = { ...this.settings, ...savedSettings };
                    this.migrateSettings();
                }

                return Storage.isSupported();
            }

            /**
             * 設定データの移行処理
             */
            migrateSettings() {
                // 古いデータ形式からの移行処理
                if (this.settings.notificationTime && !this.settings.notificationTime1) {
                    this.settings.notificationTime1 = CONFIG.DEFAULTS.NOTIFICATION_TIME_1;
                    this.settings.notificationTime2 = this.settings.notificationTime;
                    delete this.settings.notificationTime;
                }
                
                this.settings.version = CONFIG.VERSION;
            }

            /**
             * データの保存
             */
            save() {
                this.data.lastUpdated = new Date().toISOString();
                this.data.version = CONFIG.VERSION;
                
                const dataSuccess = Storage.save(CONFIG.STORAGE_KEY, this.data);
                const settingsSuccess = Storage.save(CONFIG.SETTINGS_KEY, this.settings);
                
                return dataSuccess && settingsSuccess;
            }

            /**
             * データの移行処理
             */
            migrateData(oldData) {
                if (oldData.version === CONFIG.VERSION) return oldData;

                const newData = {
                    records: {},
                    version: CONFIG.VERSION,
                    lastUpdated: new Date().toISOString()
                };

                if (oldData.records) {
                    Object.entries(oldData.records).forEach(([date, record]) => {
                        newData.records[date] = this.migrateRecord(record, date);
                    });
                }

                return newData;
            }

            /**
             * 個別レコードの移行処理
             */
            migrateRecord(record, date) {
                return {
                    date,
                    exercise: record.exercise || { completed: false, pushups: 0, situps: 0, squats: 0 },
                    massage: record.massage || { completed: false, time: 0 },
                    study: this.migrateStudyData(record.study),
                    reading: record.reading || { completed: false, time: 0, title: '' },
                    spending: this.migrateSpendingData(record.spending)
                };
            }

            /**
             * 勉強データの移行処理
             */
            migrateStudyData(studyData) {
                return {
                    completed: studyData?.completed || false,
                    english: studyData?.english || false,
                    bookkeeping: studyData?.bookkeeping || false,
                    fp: studyData?.fp || false,
                    ai: studyData?.ai || false,
                    englishMemo: studyData?.englishMemo || studyData?.memo || '',
                    bookkeepingMemo: studyData?.bookkeepingMemo || '',
                    fpMemo: studyData?.fpMemo || '',
                    aiMemo: studyData?.aiMemo || ''
                };
            }

            /**
             * 嗜好品データの移行処理
             */
            migrateSpendingData(spendingData) {
                return spendingData || {
                    completed: false,
                    coffee: 0,
                    snacks: 0,
                    alcohol: 0,
                    cigarettes: 0,
                    others: 0,
                    othersMemo: '',
                    total: 0
                };
            }

            /**
             * 記録の保存
             */
            saveRecord(recordData) {
                this.data.records[Utils.getToday()] = recordData;
                return this.save();
            }

            /**
             * 今日の記録を取得
             */
            getTodayRecord() {
                return this.data.records[Utils.getToday()] || null;
            }

            /**
             * 継続日数の計算
             */
            calculateStreak(category) {
                let streak = 0;
                const today = new Date();
                
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateStr = Utils.formatDate(checkDate);
                    
                    const record = this.data.records[dateStr];
                    if (record?.[category]?.completed) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                return streak;
            }

            /**
             * 統計データの取得
             */
            getStats() {
                const stats = {};
                CONFIG.CATEGORIES.forEach(category => {
                    stats[category] = Object.values(this.data.records)
                        .filter(record => record[category]?.completed).length;
                });
                return stats;
            }

            /**
             * 期間別データの取得
             */
            getRecordsForPeriod(period) {
                const today = new Date();
                const records = Object.values(this.data.records);

                switch (period) {
                    case 'week':
                        return this.getWeekRecords(today, records);
                    case 'month':
                        return this.getMonthRecords(today, records);
                    case 'year':
                        return this.getYearRecords(today, records);
                    case 'all':
                    default:
                        return records;
                }
            }

            /**
             * 今週のデータを取得
             */
            getWeekRecords(today, records) {
                const startOfWeek = new Date(today);
                const dayOfWeek = startOfWeek.getDay();
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startOfWeek.setDate(startOfWeek.getDate() - daysToMonday);
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);

                return records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= startOfWeek && recordDate <= endOfWeek;
                });
            }

            /**
             * 今月のデータを取得
             */
            getMonthRecords(today, records) {
                const year = today.getFullYear();
                const month = today.getMonth();

                return records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === year && recordDate.getMonth() === month;
                });
            }

            /**
             * 今年のデータを取得
             */
            getYearRecords(today, records) {
                const year = today.getFullYear();

                return records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === year;
                });
            }

            /**
             * 運動の累計データ取得
             */
            getExerciseTotals(period = 'all') {
                const totals = { pushups: 0, situps: 0, squats: 0, total: 0 };
                const records = this.getRecordsForPeriod(period);

                records.forEach(record => {
                    if (record.exercise) {
                        totals.pushups += record.exercise.pushups || 0;
                        totals.situps += record.exercise.situps || 0;
                        totals.squats += record.exercise.squats || 0;
                    }
                });

                totals.total = totals.pushups + totals.situps + totals.squats;
                return totals;
            }

            /**
             * マッサージの累計データ取得
             */
            getMassageTotals(period = 'all') {
                const records = this.getRecordsForPeriod(period);
                let totalTime = 0;
                let totalDays = 0;

                records.forEach(record => {
                    if (record.massage && record.massage.completed) {
                        totalTime += record.massage.time || 0;
                        totalDays++;
                    }
                });

                const averageTime = totalDays > 0 ? Math.round(totalTime / totalDays) : 0;

                return { totalTime, totalDays, averageTime };
            }

            /**
             * 勉強の累計データ取得
             */
            getStudyTotals(period = 'all') {
                const records = this.getRecordsForPeriod(period);
                const totals = { english: 0, bookkeeping: 0, fp: 0, ai: 0, totalDays: 0 };

                records.forEach(record => {
                    if (record.study) {
                        if (record.study.english) totals.english++;
                        if (record.study.bookkeeping) totals.bookkeeping++;
                        if (record.study.fp) totals.fp++;
                        if (record.study.ai) totals.ai++;
                        if (record.study.completed) totals.totalDays++;
                    }
                });

                return totals;
            }

            /**
             * 読書の累計データ取得
             */
            getReadingTotals(period = 'all') {
                const records = this.getRecordsForPeriod(period);
                let totalTime = 0;
                let totalDays = 0;

                records.forEach(record => {
                    if (record.reading && record.reading.completed) {
                        totalTime += record.reading.time || 0;
                        totalDays++;
                    }
                });

                const averageTime = totalDays > 0 ? Math.round(totalTime / totalDays) : 0;

                return { totalTime, totalDays, averageTime };
            }

            /**
             * 嗜好品出費の累計データ取得
             */
            getSpendingTotals(period = 'all') {
                const records = this.getRecordsForPeriod(period);
                const totals = {
                    coffee: 0, snacks: 0, alcohol: 0, cigarettes: 0, others: 0,
                    total: 0, totalDays: 0
                };

                records.forEach(record => {
                    if (record.spending && record.spending.completed) {
                        CONFIG.SPENDING_ITEMS.forEach(item => {
                            totals[item] += record.spending[item] || 0;
                        });
                        totals.total += record.spending.total || 0;
                        totals.totalDays++;
                    }
                });

                totals.averageDaily = totals.totalDays > 0 ? Math.round(totals.total / totals.totalDays) : 0;
                return totals;
            }

            /**
             * 期間情報の取得
             */
            getPeriodInfo(period) {
                const today = new Date();
                
                switch (period) {
                    case 'week':
                        return this.getWeekPeriodInfo(today);
                    case 'month':
                        return `今月 (${today.getFullYear()}年${today.getMonth() + 1}月)`;
                    case 'year':
                        return `今年 (${today.getFullYear()}年)`;
                    case 'all':
                    default:
                        return this.getAllPeriodInfo();
                }
            }

            /**
             * 今週の期間情報
             */
            getWeekPeriodInfo(today) {
                const startOfWeek = new Date(today);
                const dayOfWeek = startOfWeek.getDay();
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startOfWeek.setDate(startOfWeek.getDate() - daysToMonday);
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                
                return `今週 (${startOfWeek.getMonth() + 1}/${startOfWeek.getDate()} 〜 ${endOfWeek.getMonth() + 1}/${endOfWeek.getDate()})`;
            }

            /**
             * 全期間の情報
             */
            getAllPeriodInfo() {
                const allRecords = Object.keys(this.data.records);
                if (allRecords.length === 0) {
                    return '全期間 (記録なし)';
                }
                
                const sortedDates = allRecords.sort();
                const firstDate = new Date(sortedDates[0]);
                const lastDate = new Date(sortedDates[sortedDates.length - 1]);
                
                return `全期間 (${firstDate.getFullYear()}/${firstDate.getMonth() + 1}/${firstDate.getDate()} 〜 ${lastDate.getFullYear()}/${lastDate.getMonth() + 1}/${lastDate.getDate()})`;
            }

            /**
             * 全データの削除
             */
            clear() {
                const success = Storage.remove(CONFIG.STORAGE_KEY) && Storage.remove(CONFIG.SETTINGS_KEY);
                if (success) this.reset();
                return success;
            }
        }

        // ===============================
        // UI管理クラス
        // ===============================
        class UIManager {
            constructor() {
                this.currentTab = 'record';
                this.currentPeriod = 'week';
                this.isLoading = false;
                this.elements = {};
                this.cacheElements();
            }

            /**
             * DOM要素のキャッシュ
             */
            cacheElements() {
                Object.entries(SELECTORS).forEach(([key, selector]) => {
                    this.elements[key] = document.querySelector(selector);
                });
            }

            /**
             * UI初期化
             */
            init() {
                this.updateCurrentDate();
                this.bindEvents();
            }

            /**
             * 現在の日付を更新
             */
            updateCurrentDate() {
                if (this.elements.CURRENT_DATE) {
                    this.elements.CURRENT_DATE.textContent = Utils.getDateString(new Date());
                }
            }

            /**
             * イベントバインド
             */
            bindEvents() {
                this.bindTabEvents();
                this.bindCheckboxEvents();
                this.bindSpendingEvents();
                this.bindPeriodEvents();
                this.bindButtonEvents();
            }

            /**
             * タブ切り替えイベント
             */
            bindTabEvents() {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showTab(e.target.dataset.tab);
                    });
                });
            }

            /**
             * チェックボックス関連イベント
             */
            bindCheckboxEvents() {
                // 勉強項目
                CONFIG.SUBJECTS.forEach(subject => {
                    const checkbox = document.getElementById(subject);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            this.updateStudyCheckVisual(subject, e.target.checked);
                        });
                    }

                    // ラベルクリック
                    const header = document.querySelector(`[data-subject="${subject}"]`);
                    if (header) {
                        header.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                e.preventDefault();
                                this.toggleStudyCheck(subject);
                            }
                        });
                    }
                });

                // 通知設定
                const notificationCheckbox = document.getElementById('notification-enabled');
                if (notificationCheckbox) {
                    notificationCheckbox.addEventListener('change', (e) => {
                        this.updateNotificationVisual(e.target.checked);
                    });
                }

                const notificationToggle = document.querySelector('[data-toggle="notification"]');
                if (notificationToggle) {
                    notificationToggle.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            e.preventDefault();
                            this.toggleNotification();
                        }
                    });
                }
            }

            /**
             * 嗜好品関連イベント
             */
            bindSpendingEvents() {
                CONFIG.SPENDING_ITEMS.forEach(item => {
                    // チェックボックス
                    const checkbox = document.getElementById(item);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            this.updateSpendingCheckVisual(item, e.target.checked);
                        });
                    }

                    // ラベルクリック
                    const header = document.querySelector(`[data-item="${item}"]`);
                    if (header) {
                        header.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                e.preventDefault();
                                this.toggleSpendingCheck(item);
                            }
                        });
                    }

                    // 金額入力
                    const amountInput = document.getElementById(`${item}-amount`);
                    if (amountInput) {
                        amountInput.addEventListener('input', () => {
                            this.updateDailySpendingTotal();
                        });
                    }
                });
            }

            /**
             * 期間タブイベント
             */
            bindPeriodEvents() {
                document.querySelectorAll('.period-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showPeriod(e.target.dataset.period);
                    });
                });
            }

            /**
             * ボタンイベント
             */
            bindButtonEvents() {
                const buttonEvents = [
                    ['SAVE_RECORD', () => app.saveRecord()],
                    ['SAVE_EXERCISE', () => app.saveExercise()],
                    ['SAVE_MASSAGE', () => app.saveMassage()],
                    ['SAVE_STUDY', () => app.saveStudy()],
                    ['SAVE_READING', () => app.saveReading()],
                    ['SAVE_SPENDING', () => app.saveSpending()],
                    ['SAVE_SETTINGS', () => app.saveSettings()],
                    ['EXPORT', () => app.exportData()],
                    ['IMPORT', () => app.importData()],
                    ['CLEAR', () => app.clearAllData()]
                ];

                buttonEvents.forEach(([key, handler]) => {
                    if (this.elements[key]) {
                        this.elements[key].addEventListener('click', handler);
                    }
                });

                if (this.elements.IMPORT_FILE) {
                    this.elements.IMPORT_FILE.addEventListener('change', (e) => app.handleImportFile(e));
                }
            }

            /**
             * タブ表示
             */
            showTab(tabName) {
                if (this.isLoading || !tabName) return;

                // すべてのタブとセクションを非アクティブに
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

                // 選択されたタブとセクションをアクティブに
                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                const selectedSection = document.getElementById(tabName);

                if (selectedTab && selectedSection) {
                    selectedTab.classList.add('active');
                    selectedSection.classList.add('active');
                    this.currentTab = tabName;

                    if (tabName === 'history') {
                        this.updateHistory();
                    }
                }
            }

            /**
             * 勉強項目チェック切り替え
             */
            toggleStudyCheck(subject) {
                const checkbox = document.getElementById(subject);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.updateStudyCheckVisual(subject, checkbox.checked);
                }
            }

            /**
             * 勉強項目チェック表示更新
             */
            updateStudyCheckVisual(subject, checked) {
                const checkbox = document.getElementById(subject);
                const label = checkbox?.closest('.study-checkbox');
                
                if (checkbox && label) {
                    checkbox.checked = checked;
                    label.classList.toggle('checked', checked);
                }
            }

            /**
             * 嗜好品チェック切り替え
             */
            toggleSpendingCheck(item) {
                const checkbox = document.getElementById(item);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.updateSpendingCheckVisual(item, checkbox.checked);
                }
            }

            /**
             * 嗜好品チェック表示更新
             */
            updateSpendingCheckVisual(item, checked) {
                const checkbox = document.getElementById(item);
                const label = checkbox?.closest('.spending-checkbox');
                
                if (checkbox && label) {
                    checkbox.checked = checked;
                    label.classList.toggle('checked', checked);
                }
            }

            /**
             * 通知設定切り替え
             */
            toggleNotification() {
                const checkbox = document.getElementById('notification-enabled');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.updateNotificationVisual(checkbox.checked);
                }
            }

            /**
             * 通知設定表示更新
             */
            updateNotificationVisual(checked) {
                const checkbox = document.getElementById('notification-enabled');
                const item = checkbox?.closest('.checkbox-item');
                
                if (checkbox && item) {
                    checkbox.checked = checked;
                    item.classList.toggle('checked', checked);
                }
            }

            /**
             * 今日の出費合計を更新
             */
            updateDailySpendingTotal() {
                let total = 0;
                CONFIG.SPENDING_ITEMS.forEach(item => {
                    const amountInput = document.getElementById(`${item}-amount`);
                    if (amountInput) {
                        total += parseInt(amountInput.value) || 0;
                    }
                });

                const totalElement = document.getElementById('daily-spending-total');
                if (totalElement) {
                    totalElement.textContent = `${total.toLocaleString()}円`;
                }
            }

            /**
             * 今日の記録をUIに読み込み
             */
            loadTodayRecord(record) {
                if (!record) return;

                // 運動
                this.setFieldValue('pushups', record.exercise.pushups);
                this.setFieldValue('situps', record.exercise.situps);
                this.setFieldValue('squats', record.exercise.squats);

                // マッサージ
                this.setFieldValue('massage-time', record.massage.time);

                // 勉強
                CONFIG.SUBJECTS.forEach(subject => {
                    const isChecked = record.study[subject] || false;
                    this.updateStudyCheckVisual(subject, isChecked);
                    this.setFieldValue(`${subject}-memo`, record.study[`${subject}Memo`]);
                });

                // 読書
                this.setFieldValue('reading-time', record.reading.time);
                this.setFieldValue('book-title', record.reading.title);

                // 嗜好品
                if (record.spending) {
                    CONFIG.SPENDING_ITEMS.forEach(item => {
                        const hasSpending = (record.spending[item] || 0) > 0;
                        this.updateSpendingCheckVisual(item, hasSpending);
                        this.setFieldValue(`${item}-amount`, record.spending[item]);
                    });
                    this.setFieldValue('others-memo', record.spending.othersMemo);
                }
                
                this.updateDailySpendingTotal();
            }

            /**
             * フィールド値の設定
             */
            setFieldValue(id, value) {
                const element = document.getElementById(id);
                if (element && value !== undefined && value !== null) {
                    element.value = value === 0 ? '' : value;
                }
            }

            /**
             * 設定をUIに読み込み
             */
            loadSettings(settings) {
                const notificationTime1 = document.getElementById('notification-time-1');
                const notificationTime2 = document.getElementById('notification-time-2');
                
                if (notificationTime1) {
                    notificationTime1.value = settings.notificationTime1 || CONFIG.DEFAULTS.NOTIFICATION_TIME_1;
                }
                if (notificationTime2) {
                    notificationTime2.value = settings.notificationTime2 || CONFIG.DEFAULTS.NOTIFICATION_TIME_2;
                }
                
                this.updateNotificationVisual(settings.notificationEnabled);
            }

            /**
             * 継続日数の更新
             */
            updateStreaks(streaks) {
                Object.entries(streaks).forEach(([category, count]) => {
                    const elementId = category === 'spending' ? 'spending-streak' : `${category}-streak`;
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = `${count}日継続`;
                    }
                });
            }

            /**
             * 履歴全体の更新
             */
            updateHistory() {
                this.updateStats();
                this.updatePeriodInfo();
                this.updateExerciseTotals();
                this.updateMassageTotals();
                this.updateStudyTotals();
                this.updateReadingTotals();
                this.updateSpendingTotals();
                this.updateCalendar();
            }

            /**
             * 統計の更新
             */
            updateStats() {
                const stats = app.dataManager.getStats();
                Object.entries(stats).forEach(([category, count]) => {
                    const element = document.getElementById(`total-${category}-days`);
                    if (element) {
                        element.textContent = count;
                    }
                });
            }

            /**
             * 期間表示の切り替え
             */
            showPeriod(period) {
                if (this.isLoading || !period) return;

                this.currentPeriod = period;

                // 期間タブの更新
                document.querySelectorAll('.period-tab').forEach(tab => tab.classList.remove('active'));
                const selectedTab = document.querySelector(`[data-period="${period}"]`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                }

                // データの更新
                this.updatePeriodInfo();
                this.updateExerciseTotals();
                this.updateMassageTotals();
                this.updateStudyTotals();
                this.updateReadingTotals();
                this.updateSpendingTotals();
            }

            /**
             * 期間情報の更新
             */
            updatePeriodInfo() {
                const periodInfo = app.dataManager.getPeriodInfo(this.currentPeriod);
                const element = document.getElementById('period-info');
                if (element) {
                    element.textContent = periodInfo;
                }
            }

            /**
             * 運動履歴の更新
             */
            updateExerciseTotals() {
                const totals = app.dataManager.getExerciseTotals(this.currentPeriod);
                
                const elements = {
                    pushups: document.getElementById('total-pushups'),
                    situps: document.getElementById('total-situps'),
                    squats: document.getElementById('total-squats'),
                    total: document.getElementById('total-all-exercises')
                };

                Object.entries(elements).forEach(([key, element]) => {
                    if (element) {
                        element.textContent = `${totals[key].toLocaleString()}回`;
                    }
                });
            }

            /**
             * マッサージ履歴の更新
             */
            updateMassageTotals() {
                const totals = app.dataManager.getMassageTotals(this.currentPeriod);
                
                this.updateElement('total-massage-time', `${totals.totalTime.toLocaleString()}分`);
                this.updateElement('total-massage-days-period', `${totals.totalDays}日`);
                this.updateElement('average-massage-time', `${totals.averageTime}分`);
            }

            /**
             * 勉強履歴の更新
             */
            updateStudyTotals() {
                const totals = app.dataManager.getStudyTotals(this.currentPeriod);
                
                const elements = ['english', 'bookkeeping', 'fp', 'ai'];
                elements.forEach(subject => {
                    this.updateElement(`total-${subject}-days`, `${totals[subject]}日`);
                });
                this.updateElement('total-study-days-period', `${totals.totalDays}日`);
            }

            /**
             * 読書履歴の更新
             */
            updateReadingTotals() {
                const totals = app.dataManager.getReadingTotals(this.currentPeriod);
                
                this.updateElement('total-reading-time', `${totals.totalTime.toLocaleString()}分`);
                this.updateElement('total-reading-days-period', `${totals.totalDays}日`);
                this.updateElement('average-reading-time', `${totals.averageTime}分`);
            }

            /**
             * 嗜好品履歴の更新
             */
            updateSpendingTotals() {
                const totals = app.dataManager.getSpendingTotals(this.currentPeriod);
                
                CONFIG.SPENDING_ITEMS.forEach(item => {
                    this.updateElement(`total-${item}-amount`, `${totals[item].toLocaleString()}円`);
                });
                
                this.updateElement('total-all-spending', `${totals.total.toLocaleString()}円`);
                this.updateElement('total-spending-days', `${totals.totalDays}日`);
                this.updateElement('average-daily-spending', `${totals.averageDaily.toLocaleString()}円`);
            }

            /**
             * 要素のテキスト更新
             */
            updateElement(id, text) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                }
            }

            /**
             * カレンダーの更新
             */
            updateCalendar() {
                const calendar = document.getElementById('weekly-calendar');
                if (!calendar) return;

                calendar.innerHTML = '';

                // ヘッダー追加
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                days.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day calendar-header';
                    dayElement.textContent = day;
                    calendar.appendChild(dayElement);
                });

                // 過去7日間の日付追加
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = Utils.formatDate(date);
                    const record = app.dataManager.data.records[dateStr];

                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day calendar-date';

                    if (i === 0) {
                        dayElement.classList.add('today');
                    } else if (record && CONFIG.CATEGORIES.some(cat => record[cat]?.completed)) {
                        dayElement.classList.add('completed');
                    }

                    dayElement.textContent = date.getDate();
                    calendar.appendChild(dayElement);
                }
            }

            /**
             * ストレージ状態の更新
             */
            updateStorageStatus(isWorking) {
                if (this.elements.STORAGE_INDICATOR && this.elements.STORAGE_STATUS) {
                    this.elements.STORAGE_INDICATOR.className = `status-indicator ${isWorking ? '' : 'error'}`;
                    this.elements.STORAGE_STATUS.textContent = isWorking ? 'データ保存: 有効' : 'データ保存: 無効';
                }
            }

            /**
             * ローディング状態の設定
             */
            setLoading(isLoading) {
                this.isLoading = isLoading;
                const container = this.elements.CONTAINER;
                const buttons = document.querySelectorAll('button:not(.nav-tab)');

                if (container) {
                    container.classList.toggle('loading', isLoading);
                }

                buttons.forEach(btn => {
                    btn.disabled = isLoading;
                });
            }

            /**
             * トースト表示
             */
            showToast(message, type = 'success') {
                const toast = this.elements.TOAST;
                if (!toast) return;

                toast.textContent = message;
                toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        }

        // ===============================
        // 通知管理クラス
        // ===============================
        class NotificationManager {
            constructor() {
                this.timers = [];
            }

            /**
             * 通知許可の要求
             */
            async requestPermission() {
                if (!('Notification' in window)) return false;
                
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }
                
                return Notification.permission === 'granted';
            }

            /**
             * 通知設定
             */
            setup(settings) {
                this.clear();
                
                if (!settings.notificationEnabled || !('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;

                // 通知をスケジュール
                if (settings.notificationTime1) {
                    this.schedule(settings.notificationTime1, '🌅 朝のリマインド');
                }
                if (settings.notificationTime2) {
                    this.schedule(settings.notificationTime2, '🌙 夜のリマインド');
                }
            }

            /**
             * 通知のスケジュール
             */
            schedule(timeString, label) {
                const [hours, minutes] = timeString.split(':').map(Number);
                const now = new Date();
                const notificationTime = new Date();
                notificationTime.setHours(hours, minutes, 0, 0);

                if (notificationTime <= now) {
                    notificationTime.setDate(notificationTime.getDate() + 1);
                }

                const delay = notificationTime.getTime() - now.getTime();

                const timer = setTimeout(() => {
                    this.show(label);
                    this.schedule(timeString, label); // 24時間後に再スケジュール
                }, delay);

                this.timers.push(timer);
            }

            /**
             * 通知の表示
             */
            show(label = '') {
                if (Notification
