<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルーティン記録アプリ v2.4.1</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff6b6b;
            --text-primary: #333;
            --text-secondary: #666;
            --border-light: #ddd;
            --background-light: #f8f9fa;
            --background-white: #ffffff;
            --border-radius: 8px;
            --border-radius-large: 15px;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            padding: 10px;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--background-white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: var(--primary-gradient);
            color: var(--background-white);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .date {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: var(--background-light);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .nav-tab.active {
            background: var(--background-white);
            color: #4facfe;
            font-weight: bold;
        }

        /* Content */
        .content {
            padding: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Routine Sections */
        .routine-section {
            margin-bottom: 25px;
            background: var(--background-light);
            border-radius: var(--border-radius-large);
            padding: 20px;
            position: relative;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .section-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .streak-badge {
            background: linear-gradient(135deg, var(--warning-color), #feca57);
            color: var(--background-white);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Form Elements */
        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #4facfe;
        }

        .textarea-field {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 12px;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
            margin-top: 8px;
            transition: border-color 0.3s;
        }

        .textarea-field:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* Study Items */
        .study-item {
            margin-bottom: 20px;
            background: var(--background-white);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .study-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s;
        }

        .study-checkbox input {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .study-checkbox.checked {
            color: var(--success-color);
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: var(--primary-gradient);
            color: var(--background-white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #6c757d;
            color: var(--background-white);
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-export { background: #28a745; }
        .btn-import { background: #007bff; }
        .btn-clear { background: var(--error-color); }

        /* Checkbox Items */
        .checkbox-item {
            display: flex;
            align-items: center;
            background: var(--background-white);
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            min-width: 120px;
        }

        .checkbox-item.checked {
            background: #e8f5e8;
            border-color: var(--success-color);
        }

        .checkbox-item input {
            margin-right: 8px;
        }

        /* Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: bold;
        }

        .calendar-header {
            background: #667eea;
            color: var(--background-white);
        }

        .calendar-date {
            background: #f0f0f0;
            color: #999;
        }

        .calendar-date.completed {
            background: var(--success-color);
            color: var(--background-white);
        }

        .calendar-date.today {
            background: #2196f3;
            color: var(--background-white);
        }

        /* Statistics */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--background-light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: var(--background-white);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
            transition: var(--transition);
        }

        .toast.error {
            background: var(--error-color);
        }

        /* Settings */
        .settings-section {
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .time-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input {
            display: none;
        }

        .app-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 20px;
            padding: 15px;
            background: var(--background-light);
            border-radius: 10px;
        }

        .storage-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-indicator.error {
            background: var(--error-color);
        }

        .memo-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .routine-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <div class="header">
            <div class="version-badge">v2.4.1</div>
            <div class="date" id="current-date"></div>
            <div class="subtitle">今日のルーティンを記録しましょう</div>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="record">記録</button>
            <button class="nav-tab" data-tab="history">履歴</button>
            <button class="nav-tab" data-tab="settings">設定</button>
        </nav>

        <div class="content">
            <!-- 記録タブ -->
            <section class="section active" id="record">
                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">💪 運動</span>
                        <span class="streak-badge" id="exercise-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="pushups">腕立て伏せ（回）</label>
                        <input type="number" class="input-field" id="pushups" placeholder="回数を入力" min="0" max="9999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="situps">腹筋（回）</label>
                        <input type="number" class="input-field" id="situps" placeholder="回数を入力" min="0" max="9999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="squats">スクワット（回）</label>
                        <input type="number" class="input-field" id="squats" placeholder="回数を入力" min="0" max="9999">
                    </div>
                </div>

                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">🫧 マッサージ</span>
                        <span class="streak-badge" id="massage-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="massage-time">マッサージ時間（分）</label>
                        <input type="number" class="input-field" id="massage-time" placeholder="時間を入力" min="0" max="999">
                    </div>
                </div>

                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📚 勉強</span>
                        <span class="streak-badge" id="study-streak">0日継続</span>
                    </div>
                    
                    <div class="study-item">
                        <div class="study-item-header" data-subject="english">
                            <label class="study-checkbox">
                                <input type="checkbox" id="english">
                                <span>🇺🇸 英語</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="english-memo" placeholder="英語の学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="bookkeeping">
                            <label class="study-checkbox">
                                <input type="checkbox" id="bookkeeping">
                                <span>📊 簿記</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="bookkeeping-memo" placeholder="簿記の学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="fp">
                            <label class="study-checkbox">
                                <input type="checkbox" id="fp">
                                <span>💰 ファイナンシャルプランナー</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="fp-memo" placeholder="FPの学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>

                    <div class="study-item">
                        <div class="study-item-header" data-subject="ai">
                            <label class="study-checkbox">
                                <input type="checkbox" id="ai">
                                <span>🤖 AI</span>
                            </label>
                        </div>
                        <div class="memo-label">📝 メモ・理解したこと</div>
                        <textarea class="textarea-field" id="ai-memo" placeholder="AIの学習内容や理解したことを記録" maxlength="1000"></textarea>
                    </div>
                </div>

                <div class="routine-section">
                    <div class="section-title">
                        <span class="section-name">📖 読書</span>
                        <span class="streak-badge" id="reading-streak">0日継続</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="reading-time">読書時間（分）</label>
                        <input type="number" class="input-field" id="reading-time" placeholder="時間を入力" min="0" max="999">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="book-title">本のタイトル</label>
                        <input type="text" class="input-field" id="book-title" placeholder="本のタイトル" maxlength="100">
                    </div>
                </div>

                <button class="btn-primary" id="save-record-btn">記録を保存</button>
            </section>

            <!-- 履歴タブ -->
            <section class="section" id="history">
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-exercise-days">0</div>
                        <div class="stat-label">運動日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-massage-days">0</div>
                        <div class="stat-label">マッサージ日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-study-days">0</div>
                        <div class="stat-label">勉強日数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-reading-days">0</div>
                        <div class="stat-label">読書日数</div>
                    </div>
                </div>

                <div class="routine-section">
                    <div class="section-name">📅 過去7日間の記録</div>
                    <div class="calendar-grid" id="weekly-calendar"></div>
                </div>
            </section>

            <!-- 設定タブ -->
            <section class="section" id="settings">
                <div class="settings-section">
                    <div class="settings-title">🔔 リマインド設定</div>
                    <label class="checkbox-item" data-toggle="notification">
                        <input type="checkbox" id="notification-enabled">
                        <span>通知を有効にする</span>
                    </label>
                    <div class="input-group" style="margin-top: 15px;">
                        <label class="input-label" for="notification-time">通知時間</label>
                        <div class="time-input">
                            <input type="time" class="input-field" id="notification-time" value="20:00">
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">💾 データ管理</div>
                    <div class="data-controls">
                        <button class="btn-secondary btn-export" id="export-btn">データをエクスポート</button>
                        <button class="btn-secondary btn-import" id="import-btn">データをインポート</button>
                        <input type="file" class="file-input" id="import-file" accept=".json">
                        <button class="btn-secondary btn-clear" id="clear-btn">全データを削除</button>
                    </div>
                </div>

                <button class="btn-primary" id="save-settings-btn">設定を保存</button>

                <div class="app-info">
                    <div class="storage-status">
                        <div class="status-indicator" id="storage-indicator"></div>
                        <span id="storage-status">データ保存: 確認中...</span>
                    </div>
                    <div>ルーティン記録アプリ v2.4.1</div>
                    <div>修正: チェックボックス機能の改善</div>
                    <div>最終更新: 2025年6月16日</div>
                </div>
            </section>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        'use strict';

        // ===============================
        // 定数定義
        // ===============================
        const CONFIG = {
            VERSION: '2.4.1',
            STORAGE_KEY: 'routineAppData_v2',
            SETTINGS_KEY: 'routineAppSettings_v2',
            
            SUBJECTS: ['english', 'bookkeeping', 'fp', 'ai'],
            CATEGORIES: ['exercise', 'massage', 'study', 'reading'],
            
            LIMITS: {
                EXERCISE_MAX: 9999,
                TIME_MAX: 999,
                TEXT_MAX: 100,
                MEMO_MAX: 1000
            },
            
            DEFAULTS: {
                NOTIFICATION_TIME: '20:00',
                NOTIFICATION_ENABLED: false
            }
        };

        const SELECTORS = {
            CONTAINER: '#app-container',
            CURRENT_DATE: '#current-date',
            SAVE_RECORD: '#save-record-btn',
            SAVE_SETTINGS: '#save-settings-btn',
            EXPORT: '#export-btn',
            IMPORT: '#import-btn',
            CLEAR: '#clear-btn',
            IMPORT_FILE: '#import-file',
            TOAST: '#toast',
            STORAGE_INDICATOR: '#storage-indicator',
            STORAGE_STATUS: '#storage-status'
        };

        // ===============================
        // ユーティリティ関数
        // ===============================
        const Utils = {
            formatDate(date) {
                return date.toISOString().split('T')[0];
            },

            getToday() {
                return this.formatDate(new Date());
            },

            getDateString(date) {
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                return `${date.getMonth() + 1}月${date.getDate()}日（${days[date.getDay()]}）`;
            },

            validateNumber(value, min = 0, max = Infinity) {
                const num = parseInt(value) || 0;
                return Math.max(min, Math.min(max, num));
            },

            validateText(value, maxLength = Infinity) {
                return String(value || '').trim().substring(0, maxLength);
            },

            downloadFile(data, filename, type = 'application/json') {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ===============================
        // ストレージ管理
        // ===============================
        const Storage = {
            isSupported() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch {
                    return false;
                }
            },

            save(key, data) {
                if (!this.isSupported()) return false;
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch {
                    return false;
                }
            },

            load(key) {
                if (!this.isSupported()) return null;
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch {
                    return null;
                }
            },

            remove(key) {
                if (!this.isSupported()) return false;
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        // ===============================
        // データ管理
        // ===============================
        class DataManager {
            constructor() {
                this.reset();
            }

            reset() {
                this.data = {
                    records: {},
                    version: CONFIG.VERSION,
                    lastUpdated: new Date().toISOString()
                };

                this.settings = {
                    notificationEnabled: CONFIG.DEFAULTS.NOTIFICATION_ENABLED,
                    notificationTime: CONFIG.DEFAULTS.NOTIFICATION_TIME,
                    version: CONFIG.VERSION
                };
            }

            load() {
                const savedData = Storage.load(CONFIG.STORAGE_KEY);
                const savedSettings = Storage.load(CONFIG.SETTINGS_KEY);

                if (savedData) {
                    this.data = this.migrateData(savedData);
                }

                if (savedSettings) {
                    this.settings = { ...this.settings, ...savedSettings };
                    this.settings.version = CONFIG.VERSION;
                }

                return Storage.isSupported();
            }

            save() {
                this.data.lastUpdated = new Date().toISOString();
                this.data.version = CONFIG.VERSION;
                
                const dataSuccess = Storage.save(CONFIG.STORAGE_KEY, this.data);
                const settingsSuccess = Storage.save(CONFIG.SETTINGS_KEY, this.settings);
                
                return dataSuccess && settingsSuccess;
            }

            migrateData(oldData) {
                if (oldData.version === CONFIG.VERSION) return oldData;

                const newData = {
                    records: {},
                    version: CONFIG.VERSION,
                    lastUpdated: new Date().toISOString()
                };

                if (oldData.records) {
                    Object.entries(oldData.records).forEach(([date, record]) => {
                        newData.records[date] = this.migrateRecord(record, date);
                    });
                }

                return newData;
            }

            migrateRecord(record, date) {
                return {
                    date,
                    exercise: record.exercise || { completed: false, pushups: 0, situps: 0, squats: 0 },
                    massage: record.massage || { completed: false, time: 0 },
                    study: {
                        completed: record.study?.completed || false,
                        english: record.study?.english || false,
                        bookkeeping: record.study?.bookkeeping || false,
                        fp: record.study?.fp || false,
                        ai: record.study?.ai || false,
                        englishMemo: record.study?.englishMemo || record.study?.memo || '',
                        bookkeepingMemo: record.study?.bookkeepingMemo || '',
                        fpMemo: record.study?.fpMemo || '',
                        aiMemo: record.study?.aiMemo || ''
                    },
                    reading: record.reading || { completed: false, time: 0, title: '' }
                };
            }

            saveRecord(recordData) {
                this.data.records[Utils.getToday()] = recordData;
                return this.save();
            }

            getTodayRecord() {
                return this.data.records[Utils.getToday()] || null;
            }

            calculateStreak(category) {
                let streak = 0;
                const today = new Date();
                
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() - i);
                    const dateStr = Utils.formatDate(checkDate);
                    
                    const record = this.data.records[dateStr];
                    if (record?.[category]?.completed) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                return streak;
            }

            getStats() {
                const stats = {};
                CONFIG.CATEGORIES.forEach(category => {
                    stats[category] = Object.values(this.data.records)
                        .filter(record => record[category]?.completed).length;
                });
                return stats;
            }

            clear() {
                const success = Storage.remove(CONFIG.STORAGE_KEY) && Storage.remove(CONFIG.SETTINGS_KEY);
                if (success) this.reset();
                return success;
            }
        }

        // ===============================
        // UI管理
        // ===============================
        class UIManager {
            constructor() {
                this.currentTab = 'record';
                this.isLoading = false;
                this.elements = {};
                this.cacheElements();
            }

            cacheElements() {
                Object.entries(SELECTORS).forEach(([key, selector]) => {
                    this.elements[key] = document.querySelector(selector);
                });
            }

            init() {
                this.updateCurrentDate();
                this.bindEvents();
            }

            updateCurrentDate() {
                if (this.elements.CURRENT_DATE) {
                    this.elements.CURRENT_DATE.textContent = Utils.getDateString(new Date());
                }
            }

            bindEvents() {
                // タブ切り替え
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showTab(e.target.dataset.tab);
                    });
                });

                // 勉強項目チェックボックス - 直接checkboxにイベントを設定
                CONFIG.SUBJECTS.forEach(subject => {
                    const checkbox = document.getElementById(subject);
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            this.updateStudyCheckVisual(subject, e.target.checked);
                        });
                    }
                });

                // 勉強項目ラベルクリック
                document.querySelectorAll('[data-subject]').forEach(header => {
                    header.addEventListener('click', (e) => {
                        // checkboxがクリックされた場合は何もしない
                        if (e.target.type === 'checkbox') return;
                        
                        e.preventDefault();
                        this.toggleStudyCheck(header.dataset.subject);
                    });
                });

                // 通知チェックボックス - 直接checkboxにイベントを設定
                const notificationCheckbox = document.getElementById('notification-enabled');
                if (notificationCheckbox) {
                    notificationCheckbox.addEventListener('change', (e) => {
                        this.updateNotificationVisual(e.target.checked);
                    });
                }

                // 通知ラベルクリック
                const notificationToggle = document.querySelector('[data-toggle="notification"]');
                if (notificationToggle) {
                    notificationToggle.addEventListener('click', (e) => {
                        // checkboxがクリックされた場合は何もしない
                        if (e.target.type === 'checkbox') return;
                        
                        e.preventDefault();
                        this.toggleNotification();
                    });
                }

                // ボタンイベント
                this.bindButtonEvents();
            }

            bindButtonEvents() {
                const buttonEvents = [
                    ['SAVE_RECORD', () => app.saveRecord()],
                    ['SAVE_SETTINGS', () => app.saveSettings()],
                    ['EXPORT', () => app.exportData()],
                    ['IMPORT', () => app.importData()],
                    ['CLEAR', () => app.clearAllData()]
                ];

                buttonEvents.forEach(([key, handler]) => {
                    if (this.elements[key]) {
                        this.elements[key].addEventListener('click', handler);
                    }
                });

                if (this.elements.IMPORT_FILE) {
                    this.elements.IMPORT_FILE.addEventListener('change', (e) => app.handleImportFile(e));
                }
            }

            showTab(tabName) {
                if (this.isLoading || !tabName) return;

                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

                const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
                const selectedSection = document.getElementById(tabName);

                if (selectedTab && selectedSection) {
                    selectedTab.classList.add('active');
                    selectedSection.classList.add('active');
                    this.currentTab = tabName;

                    if (tabName === 'history') {
                        this.updateHistory();
                    }
                }
            }

            toggleStudyCheck(subject) {
                const checkbox = document.getElementById(subject);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.updateStudyCheckVisual(subject, checkbox.checked);
                }
            }

            updateStudyCheckVisual(subject, checked) {
                const checkbox = document.getElementById(subject);
                const label = checkbox?.closest('.study-checkbox');
                
                if (checkbox && label) {
                    checkbox.checked = checked;
                    label.classList.toggle('checked', checked);
                }
            }

            toggleNotification() {
                const checkbox = document.getElementById('notification-enabled');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.updateNotificationVisual(checkbox.checked);
                }
            }

            updateNotificationVisual(checked) {
                const checkbox = document.getElementById('notification-enabled');
                const item = checkbox?.closest('.checkbox-item');
                
                if (checkbox && item) {
                    checkbox.checked = checked;
                    item.classList.toggle('checked', checked);
                }
            }

            loadTodayRecord(record) {
                if (!record) return;

                // 運動
                this.setFieldValue('pushups', record.exercise.pushups);
                this.setFieldValue('situps', record.exercise.situps);
                this.setFieldValue('squats', record.exercise.squats);

                // マッサージ
                this.setFieldValue('massage-time', record.massage.time);

                // 勉強
                CONFIG.SUBJECTS.forEach(subject => {
                    const isChecked = record.study[subject] || false;
                    this.updateStudyCheckVisual(subject, isChecked);
                    this.setFieldValue(`${subject}-memo`, record.study[`${subject}Memo`]);
                });

                // 読書
                this.setFieldValue('reading-time', record.reading.time);
                this.setFieldValue('book-title', record.reading.title);
            }

            setFieldValue(id, value) {
                const element = document.getElementById(id);
                if (element && value !== undefined && value !== null) {
                    element.value = value === 0 ? '' : value;
                }
            }

            loadSettings(settings) {
                const notificationTime = document.getElementById('notification-time');
                if (notificationTime) {
                    notificationTime.value = settings.notificationTime;
                }
                
                // 通知チェックボックスの状態を設定
                this.updateNotificationVisual(settings.notificationEnabled);
            }

            updateStreaks(streaks) {
                Object.entries(streaks).forEach(([category, count]) => {
                    const element = document.getElementById(`${category}-streak`);
                    if (element) {
                        element.textContent = `${count}日継続`;
                    }
                });
            }

            updateHistory() {
                this.updateStats();
                this.updateCalendar();
            }

            updateStats() {
                const stats = app.dataManager.getStats();
                Object.entries(stats).forEach(([category, count]) => {
                    const element = document.getElementById(`total-${category}-days`);
                    if (element) {
                        element.textContent = count;
                    }
                });
            }

            updateCalendar() {
                const calendar = document.getElementById('weekly-calendar');
                if (!calendar) return;

                calendar.innerHTML = '';

                // ヘッダー
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                days.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day calendar-header';
                    dayElement.textContent = day;
                    calendar.appendChild(dayElement);
                });

                // 過去7日間
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = Utils.formatDate(date);
                    const record = app.dataManager.data.records[dateStr];

                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day calendar-date';

                    if (i === 0) {
                        dayElement.classList.add('today');
                    } else if (record && CONFIG.CATEGORIES.some(cat => record[cat]?.completed)) {
                        dayElement.classList.add('completed');
                    }

                    dayElement.textContent = date.getDate();
                    calendar.appendChild(dayElement);
                }
            }

            updateStorageStatus(isWorking) {
                if (this.elements.STORAGE_INDICATOR && this.elements.STORAGE_STATUS) {
                    this.elements.STORAGE_INDICATOR.className = `status-indicator ${isWorking ? '' : 'error'}`;
                    this.elements.STORAGE_STATUS.textContent = isWorking ? 'データ保存: 有効' : 'データ保存: 無効';
                }
            }

            setLoading(isLoading) {
                this.isLoading = isLoading;
                const container = this.elements.CONTAINER;
                const buttons = document.querySelectorAll('button:not(.nav-tab)');

                if (container) {
                    container.classList.toggle('loading', isLoading);
                }

                buttons.forEach(btn => {
                    btn.disabled = isLoading;
                });
            }

            showToast(message, type = 'success') {
                const toast = this.elements.TOAST;
                if (!toast) return;

                toast.textContent = message;
                toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        }

        // ===============================
        // 通知管理
        // ===============================
        class NotificationManager {
            constructor() {
                this.timer = null;
            }

            async requestPermission() {
                if (!('Notification' in window)) return false;
                
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }
                
                return Notification.permission === 'granted';
            }

            setup(settings) {
                this.clear();
                
                if (!settings.notificationEnabled || !('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;

                this.schedule(settings.notificationTime);
            }

            schedule(timeString) {
                const [hours, minutes] = timeString.split(':').map(Number);
                const now = new Date();
                const notificationTime = new Date();
                notificationTime.setHours(hours, minutes, 0, 0);

                if (notificationTime <= now) {
                    notificationTime.setDate(notificationTime.getDate() + 1);
                }

                const delay = notificationTime.getTime() - now.getTime();

                this.timer = setTimeout(() => {
                    this.show();
                    this.schedule(timeString); // 24時間後に再スケジュール
                }, delay);
            }

            show() {
                if (Notification.permission === 'granted') {
                    new Notification('ルーティン記録アプリ v2.4.1', {
                        body: '今日のルーティンを記録しましょう！',
                        icon: '📝',
                        tag: 'routine-reminder'
                    });
                }
            }

            clear() {
                if (this.timer) {
                    clearTimeout(this.timer);
                    this.timer = null;
                }
            }
        }

        // ===============================
        // メインアプリケーション
        // ===============================
        class RoutineApp {
            constructor() {
                this.dataManager = new DataManager();
                this.ui = new UIManager();
                this.notifications = new NotificationManager();
            }

            async init() {
                try {
                    this.ui.setLoading(true);

                    // データ読み込み
                    const storageWorking = this.dataManager.load();
                    this.ui.updateStorageStatus(storageWorking);

                    // UI初期化
                    this.ui.init();

                    // 今日の記録を読み込み
                    this.ui.loadTodayRecord(this.dataManager.getTodayRecord());

                    // 設定を読み込み
                    this.ui.loadSettings(this.dataManager.settings);

                    // 継続日数を更新
                    this.updateStreaks();

                    // 履歴を更新
                    this.ui.updateHistory();

                    // 通知設定
                    await this.notifications.requestPermission();
                    this.notifications.setup(this.dataManager.settings);

                } catch (error) {
                    console.error('App initialization failed:', error);
                    this.ui.showToast('アプリの初期化に失敗しました', 'error');
                } finally {
                    this.ui.setLoading(false);
                }
            }

            saveRecord() {
                try {
                    this.ui.setLoading(true);

                    const recordData = this.collectRecordData();
                    
                    if (this.dataManager.saveRecord(recordData)) {
                        this.updateStreaks();
                        this.ui.showToast('記録を保存しました！');
                    } else {
                        this.ui.showToast('データの保存に失敗しました', 'error');
                    }
                } catch (error) {
                    console.error('Save record failed:', error);
                    this.ui.showToast('記録の保存中にエラーが発生しました', 'error');
                } finally {
                    this.ui.setLoading(false);
                }
            }

            collectRecordData() {
                const today = Utils.getToday();

                // 運動データ
                const pushups = Utils.validateNumber(document.getElementById('pushups')?.value, 0, CONFIG.LIMITS.EXERCISE_MAX);
                const situps = Utils.validateNumber(document.getElementById('situps')?.value, 0, CONFIG.LIMITS.EXERCISE_MAX);
                const squats = Utils.validateNumber(document.getElementById('squats')?.value, 0, CONFIG.LIMITS.EXERCISE_MAX);
                const exerciseCompleted = pushups > 0 || situps > 0 || squats > 0;

                // マッサージデータ
                const massageTime = Utils.validateNumber(document.getElementById('massage-time')?.value, 0, CONFIG.LIMITS.TIME_MAX);
                const massageCompleted = massageTime > 0;

                // 勉強データ
                const studyData = {
                    completed: false,
                    english: document.getElementById('english')?.checked || false,
                    bookkeeping: document.getElementById('bookkeeping')?.checked || false,
                    fp: document.getElementById('fp')?.checked || false,
                    ai: document.getElementById('ai')?.checked || false
                };

                CONFIG.SUBJECTS.forEach(subject => {
                    const memo = Utils.validateText(document.getElementById(`${subject}-memo`)?.value, CONFIG.LIMITS.MEMO_MAX);
                    studyData[`${subject}Memo`] = memo;
                });

                studyData.completed = studyData.english || studyData.bookkeeping || studyData.fp || studyData.ai;

                // 読書データ
                const readingTime = Utils.validateNumber(document.getElementById('reading-time')?.value, 0, CONFIG.LIMITS.TIME_MAX);
                const bookTitle = Utils.validateText(document.getElementById('book-title')?.value, CONFIG.LIMITS.TEXT_MAX);
                const readingCompleted = readingTime > 0;

                return {
                    date: today,
                    exercise: { completed: exerciseCompleted, pushups, situps, squats },
                    massage: { completed: massageCompleted, time: massageTime },
                    study: studyData,
                    reading: { completed: readingCompleted, time: readingTime, title: bookTitle }
                };
            }

            updateStreaks() {
                const streaks = {};
                CONFIG.CATEGORIES.forEach(category => {
                    streaks[category] = this.dataManager.calculateStreak(category);
                });
                this.ui.updateStreaks(streaks);
            }

            saveSettings() {
                try {
                    this.ui.setLoading(true);

                    this.dataManager.settings.notificationEnabled = document.getElementById('notification-enabled')?.checked || false;
                    this.dataManager.settings.notificationTime = document.getElementById('notification-time')?.value || CONFIG.DEFAULTS.NOTIFICATION_TIME;
                    this.dataManager.settings.version = CONFIG.VERSION;

                    if (this.dataManager.save()) {
                        this.notifications.setup(this.dataManager.settings);
                        this.ui.showToast('設定を保存しました！');
                    } else {
                        this.ui.showToast('設定の保存に失敗しました', 'error');
                    }
                } catch (error) {
                    console.error('Save settings failed:', error);
                    this.ui.showToast('設定の保存中にエラーが発生しました', 'error');
                } finally {
                    this.ui.setLoading(false);
                }
            }

            exportData() {
                try {
                    const exportData = {
                        records: this.dataManager.data.records,
                        settings: this.dataManager.settings,
                        version: CONFIG.VERSION,
                        exportDate: new Date().toISOString()
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const filename = `routine_app_backup_v${CONFIG.VERSION}_${Utils.getToday()}.json`;

                    Utils.downloadFile(dataStr, filename);
                    this.ui.showToast('データをエクスポートしました！');
                } catch (error) {
                    console.error('Export failed:', error);
                    this.ui.showToast('エクスポートに失敗しました', 'error');
                }
            }

            importData() {
                document.getElementById('import-file')?.click();
            }

            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        if (!importedData.records || !importedData.settings) {
                            this.ui.showToast('無効なデータファイルです', 'error');
                            return;
                        }

                        if (confirm('現在のデータを上書きしてインポートしますか？\n（現在のデータは失われます）')) {
                            this.dataManager.data = this.dataManager.migrateData(importedData);
                            this.dataManager.settings = { ...this.dataManager.settings, ...importedData.settings };
                            this.dataManager.settings.version = CONFIG.VERSION;

                            if (this.dataManager.save()) {
                                this.ui.loadTodayRecord(this.dataManager.getTodayRecord());
                                this.ui.loadSettings(this.dataManager.settings);
                                this.updateStreaks();
                                this.ui.updateHistory();
                                this.ui.showToast('データをインポートしました！');
                            } else {
                                this.ui.showToast('インポートに失敗しました', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Import failed:', error);
                        this.ui.showToast('ファイルの読み込みに失敗しました', 'error');
                    }
                };
                
                reader.readAsText(file);
                event.target.value = '';
            }

            clearAllData() {
                if (!confirm('本当に全てのデータを削除しますか？\n（この操作は取り消せません）')) return;
                if (!confirm('最終確認：全データを削除しますか？')) return;

                try {
                    if (this.dataManager.clear()) {
                        this.notifications.clear();
                        this.ui.loadTodayRecord(null);
                        this.ui.loadSettings(this.dataManager.settings);
                        this.updateStreaks();
                        this.ui.updateHistory();
                        this.ui.showToast('全データを削除しました');
                    } else {
                        this.ui.showToast('データ削除に失敗しました', 'error');
                    }
                } catch (error) {
                    console.error('Clear data failed:', error);
                    this.ui.showToast('データ削除中にエラーが発生しました', 'error');
                }
            }
        }

        // ===============================
        // アプリケーション起動
        // ===============================
        let app;

        function initializeApp() {
            app = new RoutineApp();
            app.init().catch(console.error);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
